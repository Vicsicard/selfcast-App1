# MongoDB Integration for Self-Cast Studios

This document outlines the integration of MongoDB as the shared database for the Self-Cast Studios ecosystem, replacing the previous Supabase implementation.

## Integration Overview

The Self-Cast Studios ecosystem now uses MongoDB as the shared database across all applications:

1. **Self-Cast-Studios-Unified**: Receives workshop transcripts from Vapi webhooks
2. **App 1 (Transcript Builder)**: Processes raw transcripts into structured chunks
3. **App 2 (Style Profiler)**: Analyzes transcript chunks to extract style profiles
4. **App 3 (Content Generator Suite)**: Generates content based on style profiles
5. **Marketing Automation System**: Handles client funnel progression

## MongoDB Connection

All systems use the same MongoDB connection string:

```
mongodb+srv://vicsicard:Z6T46srM9kEGZfLJ@cluster0.tfi0dul.mongodb.net/new-self-website-5-15-25
```

## Key Collections

- `transcripts`: Raw transcripts from Vapi
- `transcript_chunks`: Processed transcript chunks from App 1
- `style_profiles`: Style profiles generated by App 2
- `content`: Generated content from App 3 using key-value structure
- `clients`: Client information for Marketing Automation
- `processing_tasks`: Tasks for inter-app communication

## App 1 (Transcript Builder) Changes

The following changes have been made to App 1:

1. **Removed Video Processing**: Video processing functionality has been removed as it's no longer needed
2. **MongoDB Integration**: Replaced Supabase with MongoDB for data storage
3. **Webhook Endpoint**: Added webhook endpoint to receive transcripts from Unified
4. **App 2 Integration**: Added functionality to trigger App 2 after processing

## Setup Instructions

1. **Install Dependencies**:
   ```
   pip install -r requirements.txt
   ```

2. **Set Up MongoDB Collections**:
   ```
   python setup_mongodb.py
   ```

3. **Verify MongoDB Integration**:
   ```
   python verify_mongodb.py
   ```

4. **Start Webhook Handler** (for receiving transcripts from Unified):
   ```
   python webhook_handler.py
   ```

## Processing Flow

1. **Unified → App 1**:
   - Unified calls App 1 webhook with transcript ID
   - App 1 processes transcript into chunks
   - Chunks are stored in MongoDB

2. **App 1 → App 2**:
   - App 1 creates processing task for App 2
   - App 1 can optionally trigger App 2 via webhook

## Key Files

- `mongodb_client.py`: MongoDB client for database operations
- `mongodb_upload.py`: Utility for uploading files to MongoDB GridFS
- `webhook_handler.py`: Flask app for receiving webhooks from Unified
- `trigger_app2.py`: Utility for triggering App 2 processing
- `setup_mongodb.py`: Script to set up MongoDB collections and indexes
- `verify_mongodb.py`: Script to verify MongoDB integration

## Environment Variables

The following environment variables can be configured:

- `MONGODB_URI`: MongoDB connection string (default: mongodb+srv://vicsicard:Z6T46srM9kEGZfLJ@cluster0.tfi0dul.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0)
- `MONGODB_DB`: MongoDB database name (default: new-self-website-5-15-25)
- `APP2_WEBHOOK_URL`: URL for App 2 webhook (default: http://localhost:5001/api/webhook/transcript)
- `PORT`: Port for webhook handler (default: 5000)

## Testing

To test the integration:

1. **Verify MongoDB Connection**:
   ```
   python verify_mongodb.py
   ```

2. **Process a VTT File**:
   ```
   python transcript_builder.py --vtt path/to/file.vtt --category test
   ```

3. **Trigger App 2 Processing**:
   ```
   python trigger_app2.py --transcript-id <id> --chunks-id <id> --webhook
   ```

## Troubleshooting

- **MongoDB Connection Issues**: Verify network connectivity and credentials
- **Missing Collections**: Run `setup_mongodb.py` to create required collections
- **Webhook Failures**: Check if App 2 webhook endpoint is accessible
- **Processing Errors**: Check logs in the `logs` directory
